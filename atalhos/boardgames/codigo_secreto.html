<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Código Secreto - Pro Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)), 
                        url('https://ngm.com.au/wp-content/uploads/2025/03/ICAC-Investigations.png');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: white; text-align: center; margin: 0; min-height: 100vh;
        }

        /* Gestão de Equipes - Agora Lado a Lado */
        #campeonato { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; background: rgba(0,0,0,0.9); padding: 10px; border-bottom: 2px solid #444; }
        #lista-equipes-config { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .equipe-config { display: flex; align-items: center; gap: 5px; background: #222; padding: 5px 10px; border-radius: 5px; border: 1px solid #444; }
        .edit-nome { background: transparent; border: none; color: #f1c40f; font-weight: bold; width: 90px; text-align: center; font-size: 0.8rem; }
        .vit-num { font-size: 1.1rem; font-weight: bold; color: #fff; background: #333; border: none; width: 35px; text-align: center; border-radius: 4px; }
        .btn-excluir { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; font-weight: bold; }

        /* Tabuleiro Responsivo */
        #tabuleiro { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            padding: 10px; 
            max-width: 95vw; 
            margin: 0 auto; 
        }
        
        /* Ajuste de tamanho dinâmico para caber no celular */
        .card { 
            aspect-ratio: 16 / 9;
            height: auto;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #dcdde1; 
            color: #2f3640; 
            font-weight: bold; 
            border-radius: 6px; 
            text-transform: uppercase; 
            font-size: clamp(0.5rem, 2.5vw, 1rem); 
            cursor: pointer; 
            transition: 0.2s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            word-break: break-all;
            padding: 2px;
        }
        
        .foco-selecao { border: 3px solid #f1c40f !important; transform: scale(1.03); z-index: 10; box-shadow: 0 0 15px #f1c40f; }
        
        .azul { background: #00a8ff !important; color: white; }
        .vinho { background: #800020 !important; color: white; } 
        .neutro { background: #fbc531 !important; color: #2f3640; }
        .preto { background: #000 !important; color: white; border: 2px solid #800020; }
        .revelada-cap { opacity: 0.2; text-decoration: line-through; filter: grayscale(1); pointer-events: none; }

        /* Placar Dinâmico */
        #container-placares { display: flex; justify-content: center; gap: 10px; padding: 10px; flex-wrap: wrap; }
        .time-box { background: #2f3640; padding: 8px; border-radius: 10px; min-width: 100px; border-bottom: 4px solid #555; }
        .score-atual { font-size: 1.5rem; font-weight: bold; font-family: monospace; }

        #qrcode { background: white; padding: 10px; display: inline-block; border-radius: 8px; margin-top: 10px; }
        .btn-geral { background: #2ecc71; color: #fff; border: none; padding: 10px 25px; font-weight: bold; border-radius: 50px; cursor: pointer; text-transform: uppercase; margin: 10px; }
        .hidden { display: none; }

        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); 
                   display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        
        /* Ajuste para o Tabuleiro do Capitão (Celular) */
        #tabuleiro-capitao { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 4px; 
            padding: 5px;
            width: 100%;
        }
    </style>
</head>
<body>

    <div id="campeonato">
        <div id="lista-equipes-config"></div>
        <button onclick="adicionarEquipe()" style="background:#2ecc71; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; font-weight:bold;">+</button>
    </div>

    <div id="overlay">
        <h2 id="msg-fim" style="font-size: 2.5rem;">FIM DE JOGO</h2>
        <div id="vitoria-info">
            <h3 id="texto-vitoria"></h3>
            <button class="btn-geral" onclick="gerarNovaRodada()">Próxima Rodada</button>
        </div>
    </div>

    <div id="tela-tv">
        <h1 style="margin:5px 0; color:#f1c40f; font-size: 1.5rem;">CÓDIGO SECRETO</h1>
        <div id="aviso-inicio" style="margin-bottom:5px; font-weight:bold; font-size: 0.9rem;"></div>
        
        <div id="tabuleiro"></div>
        <div id="container-placares"></div>

        <div id="controles">
            <button class="btn-geral" onclick="gerarNovaRodada()">Nova Rodada</button>
            <div id="qrcode"></div>
            <p style="font-size: 0.7rem; color: #888;">Capitães: Escaneiem para ver o gabarito</p>
        </div>
    </div>

    <div id="tela-capitao" class="hidden">
        <h3 id="cap-status" style="margin: 10px 0;">GABARITO DO CAPITÃO</h3>
        <div id="tabuleiro-capitao"></div>
        <button class="btn-geral" onclick="location.reload()" style="background:#555; padding: 8px 15px; font-size: 0.8rem;">Atualizar Conexão</button>
    </div>

<script>
    let peer, conn, wakeLock = null;
    let dadosPartida = { palavras: [], rodadaId: 0 };
    let equipes = [
        { id: 'azul', nome: 'AZUL', vitorias: 0, cor: '#00a8ff', progresso: 0, meta: 8 },
        { id: 'vinho', nome: 'VERMELHO', vitorias: 0, cor: '#800020', progresso: 0, meta: 8 }
    ];

    const palavrasBanco = ["MARTELO", "ESPELHO", "CADEIRA", "LÂMPADA", "TAPETE", "ESCOVA", "TOALHA", "GARFO", "PANELA", "CHAVE", "RELOGIO", "QUADRO", "JANELA", "PORTA", "GAVETA", "FOGÃO", "XÍCARA", "PRATO", "SOFÁ", "CELULAR", "CONTROLE", "TELEVISÃO", "ÁRVORE", "FLORESTA", "MONTANHA", "OCEANO", "DESERTO", "CACHOEIRA", "PLANTA", "FLOR", "SOL", "LUA", "ESTRELA", "CACHORRO", "GATO", "CAVALO", "LEÃO", "TIGRE", "MACACO", "COELHO", "URSO", "COBRA", "PEIXE", "TUBARÃO", "BALEIA", "PÁSSARO", "PATO", "GALINHA", "BORBOLETA", "BANANA", "MAÇÃ", "LARANJA", "UVA", "MELANCIA", "ARROZ", "FEIJÃO", "CARNE", "PIZZA", "HAMBÚRGUER", "BOLO", "SORVETE", "CHOCOLATE", "CAFÉ", "SUCO", "AVIÃO", "CARRO", "MOTO", "NAVIO", "TREM", "BICICLETA", "FOGUETE", "MAPA", "BRASÍLIA", "PARIS", "LONDRES", "TÓQUIO", "ROMA", "MUSEU", "BANCO", "SHOPPING", "FARMÁCIA", "FUTEBOL", "BASQUETE", "VÔLEI", "TÊNIS", "NATAÇÃO", "BOLA", "TROFÉU", "CINEMA", "FILME", "ATOR", "MÚSICA", "LIVRO", "MÉDICO", "ADVOGADO", "POLICIAL", "BOMBEIRO", "PROFESSOR", "COZINHEIRO", "PILOTO", "DENTISTA", "ENGENHEIRO", "PROGRAMADOR", "CABEÇA", "CORAÇÃO", "CÉREBRO", "MÃO", "PÉ", "OLHO", "NARIZ", "BOCA", "AMOR", "PAZ", "GUERRA", "TEMPO", "SORTE", "DINHEIRO", "RIQUEZA", "JUSTIÇA", "CÓDIGO", "ESPAÇO", "ROBÔ", "DADO", "DIAMANTE", "CASTELO", "PONTE", "CHAVEIRO", "DRAGÃO"];

    async function ativarWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }
    ativarWakeLock();

    function inicializarServidor() {
        peer = new Peer();
        peer.on('open', (id) => {
            const url = window.location.href.split('?')[0] + '?sala=' + id;
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById("qrcode"), { text: url, width: 120, height: 120 });
            configurarNovaRodada();
        });

        peer.on('connection', (c) => {
            conn = c;
            conn.on('data', (data) => {
                if (data.type === 'REVELAR') animarERevelar(data.index);
                if (data.type === 'DESTACAR') destacarNaTV(data.index);
                if (data.type === 'CANCELAR_DESTAQUE') destacarNaTV(-1);
            });
            setTimeout(() => sincronizar(), 800);
        });
    }

    function adicionarEquipe() {
        const coresExtras = ['#2ecc71', '#f1c40f', '#9b59b6', '#e67e22'];
        const novaCor = coresExtras[equipes.length % coresExtras.length];
        const id = 'extra_' + Date.now();
        equipes.push({ id: id, nome: 'NOVO TIME', vitorias: 0, cor: novaCor, progresso: 0, meta: 7 });
        atualizarInterfaceEquipes();
        gerarNovaRodada();
    }

    function removerEquipe(index) {
        if (equipes.length <= 2) return;
        if (confirm(`Remover equipe ${equipes[index].nome}?`)) {
            equipes.splice(index, 1);
            atualizarInterfaceEquipes();
            gerarNovaRodada();
        }
    }

    function atualizarInterfaceEquipes() {
        const configCont = document.getElementById('lista-equipes-config');
        const placarCont = document.getElementById('container-placares');
        configCont.innerHTML = ''; placarCont.innerHTML = '';

        equipes.forEach((eq, idx) => {
            const itemConfig = document.createElement('div');
            itemConfig.className = 'equipe-config';
            itemConfig.innerHTML = `
                <input type="text" class="edit-nome" value="${eq.nome}" oninput="equipes[${idx}].nome = this.value; atualizarNomesPlacar()">
                <input type="number" class="vit-num" value="${eq.vitorias}" onchange="equipes[${idx}].vitorias = parseInt(this.value); sincronizar()">
                ${equipes.length > 2 ? `<button class="btn-excluir" onclick="removerEquipe(${idx})">×</button>` : ''}
            `;
            configCont.appendChild(itemConfig);
            
            placarCont.innerHTML += `
                <div class="time-box" id="placar-${eq.id}" style="border-color: ${eq.cor}">
                    <div class="nome-txt" style="color:${eq.cor}; font-size:0.7rem; font-weight:bold">${eq.nome}</div>
                    <span class="score-atual">${eq.progresso}/${eq.meta}</span>
                </div>`;
        });
    }

    function atualizarNomesPlacar() {
        equipes.forEach(eq => {
            const el = document.querySelector(`#placar-${eq.id} .nome-txt`);
            if (el) el.innerText = eq.nome;
        });
        sincronizar();
    }

    function configurarNovaRodada() {
        dadosPartida.rodadaId = Date.now();
        const embaralhado = [...palavrasBanco].sort(() => 0.5 - Math.random()).slice(0, 25);
        
        let cores = ['preto'];
        equipes.forEach((eq, i) => {
            eq.progresso = 0;
            eq.meta = (i === 0) ? 9 : 8;
            cores.push(...Array(eq.meta).fill(eq.id));
        });
        
        const neutrasQtd = 25 - cores.length;
        cores.push(...Array(neutrasQtd).fill('neutro'));
        cores.sort(() => 0.5 - Math.random());

        dadosPartida.palavras = embaralhado.map((p, i) => ({ texto: p, cor: cores[i], revelada: false }));
        
        document.getElementById('aviso-inicio').innerText = `O TIME ${equipes[0].nome} COMEÇA!`;
        document.getElementById('overlay').style.display = 'none';
        
        renderizarTabuleiroTV();
        atualizarInterfaceEquipes();
        sincronizar();
    }

    function renderizarTabuleiroTV() {
        const container = document.getElementById('tabuleiro');
        container.innerHTML = '';
        dadosPartida.palavras.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `card ${p.revelada ? obterClasseCor(p.cor) : ''}`;
            if(p.revelada) div.style.backgroundColor = obterEstiloCor(p.cor);
            div.innerText = p.texto;
            div.onclick = () => { if(!p.revelada && confirm(`Revelar "${p.texto}"?`)) animarERevelar(i); };
            container.appendChild(div);
        });
    }

    function obterClasseCor(id) {
        if (id === 'neutro' || id === 'preto') return id;
        return (id === 'azul' || id === 'vinho') ? id : '';
    }

    function obterEstiloCor(id) {
        const eq = equipes.find(e => e.id === id);
        return eq ? eq.cor : '';
    }

    function animarERevelar(index) {
        const p = dadosPartida.palavras[index];
        if (p.revelada) return;
        
        p.revelada = true;
        const eqVantagem = equipes.find(e => e.id === p.cor);
        if (eqVantagem) eqVantagem.progresso++;

        renderizarTabuleiroTV();
        atualizarInterfaceEquipes();
        sincronizar();
        checarFim(p.cor);
    }

    function checarFim(cor) {
        if (cor === 'preto') {
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('texto-vitoria').innerText = "O ASSASSINO FOI REVELADO!";
        } else {
            const vencedor = equipes.find(e => e.progresso >= e.meta);
            if (vencedor) {
                vencedor.vitorias++;
                document.getElementById('overlay').style.display = 'flex';
                document.getElementById('texto-vitoria').innerText = `VITÓRIA DO TIME ${vencedor.nome}!`;
                atualizarInterfaceEquipes();
            }
        }
    }

    function destacarNaTV(index) {
        const cards = document.querySelectorAll('#tabuleiro .card');
        cards.forEach((c, i) => i === index ? c.classList.add('foco-selecao') : c.classList.remove('foco-selecao'));
    }

    function sincronizar() {
        if (conn && conn.open) {
            conn.send({ type: 'DADOS', partida: dadosPartida, equipes: equipes });
        }
    }

    function gerarNovaRodada() {
        configurarNovaRodada();
    }

    // --- LÓGICA DO CAPITÃO ---
    function iniciarCapitao(salaId) {
        document.getElementById('tela-tv').classList.add('hidden');
        document.getElementById('campeonato').classList.add('hidden');
        document.getElementById('tela-capitao').classList.remove('hidden');
        
        peer = new Peer();
        peer.on('open', () => {
            const connCap = peer.connect(salaId);
            connCap.on('open', () => {
                connCap.on('data', (data) => {
                    if (data.type === 'DADOS') {
                        renderizarGabarito(data.partida, data.equipes, connCap);
                    }
                });
            });
        });
    }

    function renderizarGabarito(partida, listaEquipes, conexao) {
        const container = document.getElementById('tabuleiro-capitao');
        container.innerHTML = '';
        partida.palavras.forEach((p, i) => {
            const div = document.createElement('div');
            const eq = listaEquipes.find(e => e.id === p.cor);
            
            div.className = `card ${p.revelada ? 'revelada-cap' : ''}`;
            
            // Cores especiais para capitão
            if (!p.revelada) {
                if (p.cor === 'preto') div.style.backgroundColor = '#000';
                else if (p.cor === 'neutro') div.style.backgroundColor = '#fbc531';
                else if (eq) div.style.backgroundColor = eq.cor;
                if (p.cor === 'preto' || eq) div.style.color = '#fff';
            }

            div.innerText = p.texto;
            div.onclick = () => {
                conexao.send({ type: 'DESTACAR', index: i });
                setTimeout(() => {
                    if (confirm(`Pedir para revelar "${p.texto}"?`)) {
                        conexao.send({ type: 'REVELAR', index: i });
                    }
                    conexao.send({ type: 'CANCELAR_DESTAQUE' });
                }, 200);
            };
            container.appendChild(div);
        });
    }

    const salaId = new URLSearchParams(window.location.search).get('sala');
    if (salaId) iniciarCapitao(salaId); else inicializarServidor();
</script>
</body>
</html>
