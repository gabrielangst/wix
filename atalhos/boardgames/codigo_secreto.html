<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Código Secreto - Pro Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)), 
                        url('https://ngm.com.au/wp-content/uploads/2025/03/ICAC-Investigations.png');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: white; text-align: center; margin: 0; min-height: 100vh;
        }

        /* Gestão de Equipes */
        #campeonato { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; background: rgba(0,0,0,0.9); padding: 10px; border-bottom: 2px solid #444; }
        .equipe-config { display: flex; align-items: center; gap: 5px; background: #222; padding: 5px 10px; border-radius: 5px; }
        .edit-nome { background: transparent; border: none; color: #f1c40f; font-weight: bold; width: 100px; text-align: center; font-size: 0.9rem; }
        .vit-num { font-size: 1.5rem; font-weight: bold; color: #fff; background: #333; border: none; width: 45px; text-align: center; border-radius: 4px; }

        /* Tabuleiro */
        #tabuleiro { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; max-width: 900px; margin: 0 auto; }
        .card { height: 85px; display: flex; align-items: center; justify-content: center; background: #dcdde1; color: #2f3640; 
                font-weight: bold; border-radius: 8px; text-transform: uppercase; font-size: 1rem; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        .foco-selecao { border: 4px solid #f1c40f !important; transform: scale(1.05); z-index: 10; box-shadow: 0 0 20px #f1c40f; }
        
        /* Cores das Cartas */
        .azul { background: #00a8ff !important; color: white; }
        .vinho { background: #800020 !important; color: white; } 
        .neutro { background: #fbc531 !important; color: #2f3640; }
        .preto { background: #000 !important; color: white; border: 2px solid #800020; }
        .revelada-cap { opacity: 0.3; text-decoration: line-through; filter: grayscale(1); pointer-events: none; }

        /* Placar Dinâmico */
        #container-placares { display: flex; justify-content: center; gap: 15px; padding: 15px; flex-wrap: wrap; }
        .time-box { background: #2f3640; padding: 10px; border-radius: 12px; min-width: 140px; border-bottom: 5px solid #555; }
        .score-atual { font-size: 2rem; font-weight: bold; font-family: monospace; }

        /* QR Code e Menu */
        #qrcode { background: white; padding: 10px; display: inline-block; border-radius: 8px; margin-top: 10px; cursor: pointer; }
        .btn-geral { background: #2ecc71; color: #fff; border: none; padding: 12px 30px; font-weight: bold; border-radius: 50px; cursor: pointer; text-transform: uppercase; margin: 10px; }
        .hidden { display: none; }

        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); 
                   display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

    <div id="campeonato">
        <div id="lista-equipes-config"></div>
        <button onclick="adicionarEquipe()" style="background:#444; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer">+</button>
    </div>

    <div id="overlay">
        <h2 id="msg-fim" style="font-size: 3rem;">FIM DE JOGO</h2>
        <div id="vitoria-info">
            <h3 id="texto-vitoria"></h3>
            <button class="btn-geral" onclick="gerarNovaRodada()">Próxima Rodada</button>
        </div>
    </div>

    <div id="tela-tv">
        <h1 style="margin:10px 0; color:#f1c40f">CÓDIGO SECRETO</h1>
        <div id="aviso-inicio" style="margin-bottom:10px; font-weight:bold;"></div>
        
        <div id="tabuleiro"></div>

        <div id="container-placares"></div>

        <div id="controles">
            <button class="btn-geral" onclick="gerarNovaRodada()">Sortear Novas Palavras</button>
            <br>
            <div id="qrcode"></div>
            <p style="font-size: 0.7rem; color: #888;">Capitães: Escaneiem para ver o gabarito único</p>
        </div>
    </div>

    <div id="tela-capitao" class="hidden">
        <h2 id="cap-status">GABARITO DO CAPITÃO</h2>
        <div id="tabuleiro-capitao" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; padding: 5px;"></div>
        <button class="btn-geral" onclick="location.reload()" style="background:#555">Atualizar Gabarito</button>
    </div>

<script>
    // Configurações Iniciais
    let peer, conn, wakeLock = null;
    let dadosPartida = { palavras: [], rodadaId: 0 };
    let equipes = [
        { id: 'azul', nome: 'AZUL', vitorias: 0, cor: '#00a8ff', progresso: 0, meta: 8 },
        { id: 'vinho', nome: 'VERMELHO', vitorias: 0, cor: '#800020', progresso: 0, meta: 8 }
    ];

    const palavrasBanco = ["MARTELO", "ESPELHO", "CADEIRA", "LÂMPADA", "TAPETE", "ESCOVA", "TOALHA", "GARFO", "PANELA", "CHAVE", "RELOGIO", "QUADRO", "JANELA", "PORTA", "GAVETA", "FOGÃO", "XÍCARA", "PRATO", "SOFÁ", "CELULAR", "CONTROLE", "TELEVISÃO", "ÁRVORE", "FLORESTA", "MONTANHA", "OCEANO", "DESERTO", "CACHOEIRA", "PLANTA", "FLOR", "SOL", "LUA", "ESTRELA", "CACHORRO", "GATO", "CAVALO", "LEÃO", "TIGRE", "MACACO", "COELHO", "URSO", "COBRA", "PEIXE", "TUBARÃO", "BALEIA", "PÁSSARO", "PATO", "GALINHA", "BORBOLETA", "BANANA", "MAÇÃ", "LARANJA", "UVA", "MELANCIA", "ARROZ", "FEIJÃO", "CARNE", "PIZZA", "HAMBÚRGUER", "BOLO", "SORVETE", "CHOCOLATE", "CAFÉ", "SUCO", "AVIÃO", "CARRO", "MOTO", "NAVIO", "TREM", "BICICLETA", "FOGUETE", "MAPA", "BRASÍLIA", "PARIS", "LONDRES", "TÓQUIO", "ROMA", "MUSEU", "BANCO", "SHOPPING", "FARMÁCIA", "FUTEBOL", "BASQUETE", "VÔLEI", "TÊNIS", "NATAÇÃO", "BOLA", "TROFÉU", "CINEMA", "FILME", "ATOR", "MÚSICA", "LIVRO", "MÉDICO", "ADVOGADO", "POLICIAL", "BOMBEIRO", "PROFESSOR", "COZINHEIRO", "PILOTO", "DENTISTA", "ENGENHEIRO", "PROGRAMADOR", "CABEÇA", "CORAÇÃO", "CÉREBRO", "MÃO", "PÉ", "OLHO", "NARIZ", "BOCA", "AMOR", "PAZ", "GUERRA", "TEMPO", "SORTE", "DINHEIRO", "RIQUEZA", "JUSTIÇA", "CÓDIGO", "ESPAÇO", "ROBÔ", "DADO", "DIAMANTE", "CASTELO", "PONTE", "CHAVEIRO", "DRAGÃO"];

    // Manter Tela Ligada (Wake Lock)
    async function ativarWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }
    ativarWakeLock();

    function inicializarServidor() {
        peer = new Peer();
        peer.on('open', (id) => {
            const url = window.location.href.split('?')[0] + '?sala=' + id;
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById("qrcode"), { text: url, width: 140, height: 140 });
            configurarNovaRodada();
        });

        peer.on('connection', (c) => {
            conn = c;
            conn.on('data', (data) => {
                if (data.type === 'REVELAR') animarERevelar(data.index);
                if (data.type === 'DESTACAR') destacarNaTV(data.index);
                if (data.type === 'CANCELAR_DESTAQUE') destacarNaTV(-1);
            });
            setTimeout(() => sincronizar(), 500);
        });
    }

    function adicionarEquipe() {
        const coresExtras = ['#2ecc71', '#f1c40f', '#9b59b6', '#e67e22'];
        const novaCor = coresExtras[equipes.length % coresExtras.length];
        const id = 'extra_' + equipes.length;
        equipes.push({ id: id, nome: 'NOVO TIME', vitorias: 0, cor: novaCor, progresso: 0, meta: 7 });
        atualizarInterfaceEquipes();
        gerarNovaRodada();
    }

    function atualizarInterfaceEquipes() {
        const configCont = document.getElementById('lista-equipes-config');
        const placarCont = document.getElementById('container-placares');
        configCont.innerHTML = ''; placarCont.innerHTML = '';

        equipes.forEach((eq, idx) => {
            // Config no topo
            configCont.innerHTML += `
                <div class="equipe-config">
                    <input type="text" class="edit-nome" value="${eq.nome}" onchange="equipes[${idx}].nome = this.value; sincronizar()">
                    <input type="number" class="vit-num" value="${eq.vitorias}" onchange="equipes[${idx}].vitorias = parseInt(this.value); sincronizar()">
                </div>`;
            
            // Box de pontuação na TV
            placarCont.innerHTML += `
                <div class="time-box" style="border-color: ${eq.cor}">
                    <div style="color:${eq.cor}; font-size:0.8rem; font-weight:bold">${eq.nome}</div>
                    <span class="score-atual">${eq.progresso}/${eq.meta}</span>
                </div>`;
        });
    }

    function configurarNovaRodada() {
        dadosPartida.rodadaId = Date.now();
        const embaralhado = [...palavrasBanco].sort(() => 0.5 - Math.random()).slice(0, 25);
        
        // Lógica de distribuição de cores (Equilibrada)
        let cores = ['preto']; // O assassino
        equipes.forEach((eq, i) => {
            eq.progresso = 0;
            eq.meta = (i === 0) ? 9 : 8; // Primeiro time tem 1 a mais
            cores.push(...Array(eq.meta).fill(eq.id));
        });
        
        const neutrasQtd = 25 - cores.length;
        cores.push(...Array(neutrasQtd).fill('neutro'));
        cores.sort(() => 0.5 - Math.random());

        dadosPartida.palavras = embaralhado.map((p, i) => ({ texto: p, cor: cores[i], revelada: false }));
        
        document.getElementById('aviso-inicio').innerText = `O TIME ${equipes[0].nome} COMEÇA!`;
        renderizarTabuleiroTV();
        atualizarInterfaceEquipes();
        sincronizar();
    }

    function renderizarTabuleiroTV() {
        const container = document.getElementById('tabuleiro');
        container.innerHTML = '';
        dadosPartida.palavras.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `card ${p.revelada ? obterClasseCor(p.cor) : ''}`;
            div.innerText = p.texto;
            div.onclick = () => { if(!p.revelada && confirm(`Revelar "${p.texto}"?`)) animarERevelar(i); };
            container.appendChild(div);
        });
    }

    function obterClasseCor(id) {
        if (id === 'neutro' || id === 'preto') return id;
        const eq = equipes.find(e => e.id === id);
        return eq ? (id.includes('extra') ? 'neutro' : id) : 'neutro'; 
        // Nota: para cores extras personalizadas, precisaria de CSS dinâmico. Aqui tratamos como neutro visual ou use as classes azul/vinho.
    }

    function animarERevelar(index) {
        const p = dadosPartida.palavras[index];
        if (p.revelada) return;
        
        p.revelada = true;
        const eqVantagem = equipes.find(e => e.id === p.cor);
        if (eqVantagem) eqVantagem.progresso++;

        renderizarTabuleiroTV();
        atualizarInterfaceEquipes();
        sincronizar();
        checarFim(p.cor);
    }

    function checarFim(cor) {
        if (cor === 'preto') {
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('texto-vitoria').innerText = "O ASSASSINO FOI REVELADO!";
        } else {
            const vencedor = equipes.find(e => e.progresso >= e.meta);
            if (vencedor) {
                vencedor.vitorias++;
                document.getElementById('overlay').style.display = 'flex';
                document.getElementById('texto-vitoria').innerText = `VITÓRIA DO TIME ${vencedor.nome}!`;
                atualizarInterfaceEquipes();
            }
        }
    }

    function destacarNaTV(index) {
        const cards = document.querySelectorAll('#tabuleiro .card');
        cards.forEach((c, i) => i === index ? c.classList.add('foco-selecao') : c.classList.remove('foco-selecao'));
    }

    function sincronizar() {
        if (conn && conn.open) {
            conn.send({ type: 'DADOS', partida: dadosPartida, equipes: equipes });
        }
    }

    function gerarNovaRodada() {
        document.getElementById('overlay').style.display = 'none';
        configurarNovaRodada();
    }

    // --- LÓGICA DO CAPITÃO ---
    function iniciarCapitao(salaId) {
        document.getElementById('tela-tv').classList.add('hidden');
        document.getElementById('campeonato').classList.add('hidden');
        document.getElementById('tela-capitao').classList.remove('hidden');
        
        peer = new Peer();
        peer.on('open', () => {
            const connCap = peer.connect(salaId);
            connCap.on('data', (data) => {
                if (data.type === 'DADOS') {
                    renderizarGabarito(data.partida, data.equipes, connCap);
                }
            });
        });
    }

    function renderizarGabarito(partida, listaEquipes, conexao) {
        const container = document.getElementById('tabuleiro-capitao');
        container.innerHTML = '';
        partida.palavras.forEach((p, i) => {
            const div = document.createElement('div');
            // Identifica a cor do time ou especial
            let corEstilo = p.cor;
            const eq = listaEquipes.find(e => e.id === p.cor);
            const style = eq ? `background-color:${eq.cor}; color:white;` : '';

            div.className = `card ${p.revelada ? 'revelada-cap' : ''} ${!eq ? p.cor : ''}`;
            if (style && !p.revelada) div.setAttribute('style', style);
            div.innerText = p.texto;
            
            div.onclick = () => {
                conexao.send({ type: 'DESTACAR', index: i });
                setTimeout(() => {
                    if (confirm(`Solicitar revelação de "${p.texto}" na TV?`)) {
                        conexao.send({ type: 'REVELAR', index: i });
                    } else {
                        conexao.send({ type: 'CANCELAR_DESTAQUE' });
                    }
                }, 100);
            };
            container.appendChild(div);
        });
    }

    const salaId = new URLSearchParams(window.location.search).get('sala');
    if (salaId) iniciarCapitao(salaId); else inicializarServidor();
</script>
</body>
</html>
