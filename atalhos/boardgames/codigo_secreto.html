<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Código Secreto TV</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)), 
                        url('https://ngm.com.au/wp-content/uploads/2025/03/ICAC-Investigations.png');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: white; text-align: center; margin: 0; min-height: 100vh;
        }

        #campeonato { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; background: rgba(0,0,0,0.9); padding: 10px; border-bottom: 2px solid #444; }
        #lista-equipes-config { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .equipe-config { display: flex; align-items: center; gap: 5px; background: #222; padding: 5px 10px; border-radius: 5px; border: 1px solid #444; }
        .edit-nome { background: transparent; border: none; color: #f1c40f; font-weight: bold; width: 90px; text-align: center; font-size: 0.8rem; }
        .vit-num { font-size: 1.1rem; font-weight: bold; color: #fff; background: #333; border: none; width: 35px; text-align: center; border-radius: 4px; }
        .btn-excluir { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; font-weight: bold; }

        #tabuleiro { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .card { height: 90px; display: flex; align-items: center; justify-content: center; background: #dcdde1; color: #2f3640; font-weight: bold; border-radius: 8px; text-transform: uppercase; font-size: 1.1rem; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); padding: 5px; }

        @media (max-width: 600px) {
            #tabuleiro-capitao { display: grid !important; grid-template-columns: repeat(5, 1fr) !important; gap: 4px !important; padding: 5px !important; width: 98vw !important; }
            #tabuleiro-capitao .card { height: 55px !important; font-size: 0.6rem !important; border-radius: 4px; }
        }
        
        .foco-selecao { border: 4px solid #f1c40f !important; transform: scale(1.05); z-index: 10; box-shadow: 0 0 20px #f1c40f; }
        .azul { background: #00a8ff !important; color: white; }
        .vinho { background: #800020 !important; color: white; } 
        .neutro { background: #fbc531 !important; color: #2f3640; }
        .preto { background: #000 !important; color: white; border: 2px solid #800020; }
        .revelada-cap { opacity: 0.2; text-decoration: line-through; filter: grayscale(1); pointer-events: none; }

        #container-placares { display: flex; justify-content: center; gap: 15px; padding: 15px; flex-wrap: wrap; }
        .time-box { background: #2f3640; padding: 10px; border-radius: 12px; min-width: 130px; border-bottom: 5px solid #555; transition: 0.3s; position: relative; }
        
        /* Efeito de destaque para o turno */
        .turno-ativo { 
            background: #3d4856; 
            border-bottom: 5px solid #2ecc71 !important; 
            transform: scale(1.1); 
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.4);
            z-index: 5;
        }
        .indicador-vez { font-size: 0.6rem; color: #2ecc71; font-weight: bold; display: none; margin-top: 5px; }
        .turno-ativo .indicador-vez { display: block; animation: blink 1s infinite; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .score-atual { font-size: 2rem; font-weight: bold; font-family: monospace; }
        #qrcode-link { display: inline-block; transition: transform 0.2s; }
        #qrcode-link:hover { transform: scale(1.05); }
        #qrcode { background: white; padding: 10px; display: inline-block; border-radius: 8px; margin-top: 10px; cursor: pointer; }
        .btn-geral { background: #2ecc71; color: #fff; border: none; padding: 12px 30px; font-weight: bold; border-radius: 50px; cursor: pointer; text-transform: uppercase; margin: 10px; }
        .hidden { display: none; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

    <div id="campeonato">
        <div id="lista-equipes-config"></div>
        <button onclick="adicionarEquipe()" style="background:#2ecc71; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; font-weight:bold;">+</button>
    </div>

    <div id="overlay">
        <h2 id="msg-fim" style="font-size: 3rem;">FIM DE JOGO</h2>
        <div id="vitoria-info">
            <h3 id="texto-vitoria"></h3>
            <button class="btn-geral" onclick="gerarNovaRodada()">Próxima Rodada</button>
        </div>
    </div>

    <div id="tela-tv">
        <h1 style="margin:15px 0; color:#f1c40f">CÓDIGO SECRETO</h1>
        <div id="aviso-inicio" style="margin-bottom:10px; font-weight:bold;"></div>
        
        <div id="tabuleiro"></div>
        <div id="container-placares"></div>

        <div id="controles">
            <button class="btn-geral" onclick="gerarNovaRodada()">Sortear Novas Palavras</button>
            <br>
            <a id="qrcode-link" href="#" target="_blank">
                <div id="qrcode"></div>
            </a>
            <p style="font-size: 0.7rem; color: #888;">Capitães: Escaneiem ou cliquem no código para o gabarito</p>
        </div>
    </div>

    <div id="tela-capitao" class="hidden">
        <h3 id="cap-status">GABARITO DO CAPITÃO</h3>
        <div id="tabuleiro-capitao"></div>
        <button class="btn-geral" onclick="location.reload()" style="background:#555">Atualizar Gabarito</button>
    </div>

<script>
    let peer, conn, wakeLock = null;
    let dadosPartida = { palavras: [], rodadaId: 0, indexTurno: 0, rodadaContador: 0 };
    let equipes = [
        { id: 'azul', nome: 'AZUL', vitorias: 0, cor: '#00a8ff', progresso: 0, meta: 8 },
        { id: 'vinho', nome: 'VERMELHO', vitorias: 0, cor: '#800020', progresso: 0, meta: 8 }
    ];

    const palavrasBanco = [
        // SUAS PALAVRAS ORIGINAIS
        "MARTELO", "ESPELHO", "CADEIRA", "LÂMPADA", "TAPETE", "ESCOVA", "TOALHA", "GARFO", 
        "PANELA", "CHAVE", "RELOGIO", "QUADRO", "JANELA", "PORTA", "GAVETA", "FOGÃO", 
        "XÍCARA", "PRATO", "SOFÁ", "CELULAR", "CONTROLE", "TELEVISÃO", "ÁRVORE", "FLORESTA", 
        "MONTANHA", "OCEANO", "DESERTO", "CACHOEIRA", "PLANTA", "FLOR", "SOL", "LUA", 
        "ESTRELA", "CACHORRO", "GATO", "CAVALO", "LEÃO", "TIGRE", "MACACO", "COELHO", 
        "URSO", "COBRA", "PEIXE", "TUBARÃO", "BALEIA", "PÁSSARO", "PATO", "GALINHA", 
        "BORBOLETA", "BANANA", "MAÇÃ", "LARANJA", "UVA", "MELANCIA", "ARROZ", "FEIJÃO", 
        "CARNE", "PIZZA", "HAMBÚRGUER", "BOLO", "SORVETE", "CHOCOLATE", "CAFÉ", "SUCO", 
        "AVIÃO", "CARRO", "MOTO", "NAVIO", "TREM", "BICICLETA", "FOGUETE", "MAPA", 
        "BRASÍLIA", "PARIS", "LONDRES", "TÓQUIO", "ROMA", "MUSEU", "BANCO", "SHOPPING", 
        "FARMÁCIA", "FUTEBOL", "BASQUETE", "VÔLEI", "TÊNIS", "NATAÇÃO", "BOLA", "TROFÉU", 
        "CINEMA", "FILME", "ATOR", "MÚSICA", "LIVRO", "MÉDICO", "ADVOGADO", "POLICIAL", 
        "BOMBEIRO", "PROFESSOR", "COZINHEIRO", "PILOTO", "DENTISTA", "ENGENHEIRO", "PROGRAMADOR", 
        "CABEÇA", "CORAÇÃO", "CÉREBRO", "MÃO", "PÉ", "OLHO", "NARIZ", "BOCA", "AMOR", 
        "PAZ", "GUERRA", "TEMPO", "SORTE", "DINHEIRO", "RIQUEZA", "JUSTIÇA", "CÓDIGO", 
        "ESPAÇO", "ROBÔ", "DADO", "DIAMANTE", "CASTELO", "PONTE", "CHAVEIRO", "DRAGÃO",

        // NOVAS PALAVRAS ADICIONADAS
        "ABACATE", "ABACAXI", "ABELHA", "ABISMO", "ABÓBORA", "ABRIGO", "ACAMPAMENTO", "ACORDO",
        "AÇÚCAR", "ÁGUIA", "AGULHA", "ALDEIA", "ALFACE", "ALGODÃO", "ALMA", "ALMOFADA",
        "ALVO", "AMENDOIM", "AMIGO", "ANEL", "ANJO", "ANTENA", "ANÚNCIO", "APARTAMENTO",
        "APITO", "AQUÁRIO", "ARANHA", "ARCO", "AREIA", "ARMADURA", "ARMÁRIO", "ARQUIVO",
        "ARTE", "ASILO", "ASSASSINO", "ASTRO", "ASTRONAUTA", "ATAQUE", "ATLETA", "AURA",
        "AVENIDA", "AVENTAL", "AZEITE", "BACON", "BACTÉRIA", "BAILARINA", "BALA", "BALANÇA",
        "BALÃO", "BALCÃO", "BALDE", "BAMBU", "BANDA", "BANDEIRA", "BANHEIRA", "BANHEIRO",
        "BAR", "BARALHO", "BARATA", "BARBA", "BARCO", "BARRA", "BARRACA", "BARRIL",
        "BASE", "BATERIA", "BATOM", "BEBÊ", "BEIJO", "BENGALA", "BERÇO", "BESOURO",
        "BICO", "BISCOITO", "BOI", "BOLSO", "BOMBA", "BONECA", "BONECO", "BORRACHA",
        "BOTA", "BOTÃO", "BRAÇO", "BRANCO", "BRUXA", "BÚSSOLA", "CABANA", "CABEAMENTO",
        "CABELO", "CABIDE", "CABO", "CAÇADOR", "CADEADO", "CADERNO", "CAFETEIRA", "CAIXA",
        "CAIXÃO", "CALÇA", "CALENDÁRIO", "CAMA", "CAMARÃO", "CAMELO", "CÂMERA", "CAMINHÃO",
        "CAMISA", "CAMISETA", "CAMPEÃO", "CAMPO", "CANAL", "CANETA", "CANGURU", "CANHÃO",
        "CANTOR", "CANUDO", "CAPA", "CAPACETE", "CAPITÃO", "CARACOL", "CARANGUEJO", "CARAVANA",
        "CARTA", "CARTÃO", "CARTAZ", "CARTEIRA", "CARVÃO", "CASA", "CASACO", "CASAMENTO",
        "CASCATA", "CAVALEIRO", "CAVERNA", "CEBOLA", "CEGO", "CENOURA", "CENTAURO", "CERA",
        "CERCA", "CÉU", "CHÁ", "CHAPÉU", "CHEFE", "CHICOTE", "CHIFRE", "CHINA",
        "CHOQUE", "CHORRO", "CHURRASCO", "CHUVA", "CIÊNCIA", "CIENTISTA", "CIGARRO", "CILINDRO",
        "CINTO", "CINTURÃO", "CIRCO", "CÍRCULO", "CIRURGIA", "CLÍNICA", "CLUBE", "COBERTOR",
        "COBRE", "COELHEIRA", "COFRE", "COLA", "COLAR", "COLCHÃO", "COLETE", "COLHER",
        "COLUNA", "COMBOIO", "COMETA", "COMPUTADOR", "CONCHA", "CONCURSO", "CONDUTOR", "CONTO",
        "CONTRATO", "COPO", "COR", "CORDA", "CORNETA", "COROA", "CORPO", "CORRIDA",
        "CORTE", "CORUJA", "CORVO", "COSMOS", "COSTAS", "COUVE", "COZINHA", "CRÂNIO",
        "CRAVO", "CRIME", "CRISTAL", "CRUZ", "CUBO", "CULPA", "CURATIVO", "CURSO",
        "DANÇA", "DEGRAU", "DEDO", "DEFESA", "DELEGAÇÃO", "DEMÔNIO", "DENTE", "DESENHO",
        "DETETIVE", "DEUS", "DIA", "DIÁRIO", "DIETA", "DINAMITE", "DINOSSAURO", "DIRETOR",
        "DISCO", "DOENÇA", "DOCE", "DOCUMENTO", "DOLLAR", "DOR", "DOSE", "DOUTOR",
        "ECLIPSE", "ECONOMIA", "EDIFÍCIO", "EGITO", "ELEFANTE", "ELEVADOR", "ELFO", "EMBAIXADA",
        "EMPREGO", "EMPRESA", "ENERGIA", "ENFERMEIRA", "ENGENHO", "ENXADA", "ERRO", "ESCADA",
        "ESCALA", "ESCORPIÃO", "ESCURIDÃO", "ESCUDO", "ESMERALDA", "ESORCISTA", "ESPADÃO", "ESPERANÇA",
        "ESPIÃO", "ESPÍRITO", "ESQUELETO", "ESQUILO", "ESTAÇÃO", "ESTÁDIO", "ESTÁTUA", "ESTRADA",
        "ESTUDANTE", "ESTÚDIO", "ET", "EUROPA", "EXAME", "EXÉRCITO", "FÁBRICA", "FACA",
        "FADA", "FAIXA", "FALCÃO", "FANTASMA", "FAROL", "FATO", "FAZENDA", "FEBRE",
        "FEITIÇO", "FÊNIX", "FERRO", "FESTA", "FIO", "FLAUTA", "FLECHA", "FOCA",
        "FOGO", "FOLHA", "FONTE", "FORÇA", "FORMIGA", "FORNO", "FOSSO", "FOTO",
        "FOTOGRAFIA", "FRANÇA", "FRANGO", "FRONTEIRA", "FRUTA", "FUGA", "FUMAÇA", "FUNDO",
        "FURACÃO", "FUTEBOL", "GAFANHOTO", "GAIOLA", "GALÁXIA", "GALHO", "GARAGEM", "GARRA",
        "GARRAFA", "GÁS", "GELO", "GÊMEO", "GÊNIO", "GIGANTE", "GINÁSIO", "GIRAFA",
        "GIZ", "GLOBO", "GNOMO", "GOL", "GOLFINHO", "GOLPE", "GOTA", "GOVERNO",
        "GRAÇA", "GRADE", "GRAMA", "GRÃO", "GRAVATA", "GREVE", "GRITO", "GROTA",
        "GRUPO", "GUARDA", "GUITARRA", "HELICÓPTERO", "HERÓI", "HIDRANTE", "HIENA", "HIPOPÓTAMO",
        "HISTÓRIA", "HOLLYWOOD", "HOMEM", "HONRA", "HORA", "HOSPITAL", "HOTEL", "HUMANIDADE",
        "ÍDOLO", "IGREJA", "ILHA", "ILUSÃO", "IMAGEM", "ÍMÃ", "IMPERADOR", "IMPÉRIO",
        "INFERNO", "INGLATERRA", "INGRESSO", "INIMIGO", "INSETO", "INSTRUMENTO", "INVERNO", "IRMÃO",
        "ISCA", "JACARÉ", "JARDIM", "JAQUETA", "JAULA", "JAVALI", "JAZZ", "JEGUE",
        "JOGO", "JÓIA", "JOELHO", "JORNAL", "JORNALISTA", "JUIZ", "JULGAMENTO", "JUPITER",
        "LABIRINTO", "LAÇO", "LADRÃO", "LAGO", "LÁGRIMA", "LAMA", "LÂMINA", "LANÇA",
        "LANCHA", "LANTERNA", "LÁPIS", "LATA", "LAVAGEM", "LEÃO", "LEI", "LEITE",
        "LENTE", "LENÇO", "LEOPARDO", "LETRA", "LÍDER", "LIGAÇÃO", "LIMÃO", "LÍNGUA",
        "LINHA", "LIXO", "LOBO", "LOJA", "LOTE", "LOUCURA", "LUVA", "LUZ",
        "MACA", "MACHADO", "MADRUGADA", "MÁGICA", "MÁGICO", "MAGO", "MAIONESE", "MALA",
        "MALETA", "MALHA", "MAMÃO", "MANADA", "MANCHA", "MANGA", "MANGUEIRA", "MANSÃO",
        "MANTEIGA", "MÁQUINA", "MAR", "MARCA", "MARCHA", "MARINHEIRO", "MARTE", "MARTÍN",
        "MÁSCARA", "MASSA", "MATEMÁTICA", "MATO", "MECÂNICO", "MEDALHA", "MEDICINA", "MEDO",
        "MEIA", "MEIO", "MEL", "MEMÓRIA", "MENINA", "MENINO", "MENSAGEM", "MENTE",
        "MERCADO", "MESA", "MESTRE", "METAL", "METEORO", "METRÔ", "MÉXICO", "MICROFONE",
        "MICROSCOPIO", "MILHO", "MINA", "MINISTRO", "MINUTO", "MISTÉRIO", "MOCHILA", "MOEDA",
        "MOLA", "MOLDURA", "MOLEQUE", "MONGE", "MONSTRO", "MORANGO", "MORCEGO", "MORTE",
        "MOSCA", "MOSQUITO", "MOTOR", "MOTORISTA", "MOTO-SERRA", "MURO", "MÚSCULO", "MUSEU",
        "NATUREZA", "NAVALHA", "NAVE", "NEBLINA", "NEVE", "NINJA", "NINHO", "NOITE",
        "NOME", "NOVA", "NOVELO", "NUVEM", "OÁSIS", "ÓCULOS", "ÓDIO", "ÓLEO",
        "OLIMPÍADA", "OMBRO", "ONÇA", "ONDA", "ÔNIBUS", "OPERAÇÃO", "ÓRGÃO", "ORGULHO",
        "OSSO", "OURO", "OUTONO", "OVELHA", "OVO", "ÓVNI", "PACIENTE", "PACOTE",
        "PADRE", "PAGAMENTO", "PÁGINA", "PAI", "PALÁCIO", "PALCO", "PALHAÇO", "PALITO",
        "PALMA", "PÃO", "PAPEL", "PARAQUEDAS", "PARAFUSO", "PAREDE", "PARQUE", "PARTIDA",
        "PASSAGEM", "PASSAPORTE", "PASSEIO", "PASTA", "PASTEL", "PATINS", "PATRÃO", "PAZ",
        "PEÇA", "PECADO", "PEDAL", "PEDRA", "PEGADA", "PEITO", "PELO", "PÊNALTI",
        "PENA", "PENSAMENTO", "PENTE", "PERFUME", "PERIGO", "PERNA", "PÉROLA", "PERSONAGEM",
        "PESADELO", "PESCADOR", "PESCOÇO", "PESO", "PESQUISA", "PÊSSEGO", "PETRÓLEO", "PIANO",
        "PICARETA", "PILHA", "PINGUIM", "PINO", "PINTOR", "PINTURA", "PIOLHO", "PIPA",
        "PIRÂMIDE", "PIRATA", "PISTA", "PISTOLA", "PLACA", "PLANETA", "PLÁSTICO", "PNEU",
        "POÇO", "POEIRA", "POEMA", "POETA", "POLEGAR", "POLÍCIA", "POLVO", "POMBA",
        "PONTO", "PORCO", "PORTÃO", "PORTO", "POSIÇÃO", "POSTO", "POTE", "PRAÇA",
        "PRAIA", "PRATA", "PRÉDIO", "PREGO", "PRÊMIO", "PRESENTE", "PRESIDENTE", "PRESO",
        "PRIMAVERA", "PRINCESA", "PRÍNCIPE", "PRISÃO", "PROBLEMA", "PROJETO", "PROVA", "PULGA",
        "PULMÃO", "PULSEIRA", "PUNHAL", "QUEBRA-CABEÇA", "QUEDA", "QUEIJO", "QUÍMICA", "QUINTAL",
        "RABO", "RADAR", "RÁDIO", "RAIO", "RAIZ", "RAMO", "RAPOSA", "RATO",
        "RAZÃO", "REALEZA", "REBATEDOR", "REBANHO", "RECIBO", "REDE", "REFÉM", "REGRA",
        "REI", "REINO", "RELÂMPAGO", "RELIGIÃO", "REMÉDIO", "REMO", "REPOLHO", "REPÓRTER",
        "RESTAURANTE", "RETRATO", "RÉGUA", "RINOCERONTE", "RIO", "RISO", "RITMO", "ROCHA",
        "RODA", "RODADA", "ROMANCE", "ROSA", "ROSTO", "ROTA", "ROUPÃO", "RUA",
        "RUBI", "SABÃO", "SABONETE", "SACO", "SAIA", "SAÍDA", "SAL", "SALA",
        "SALADA", "SALÁRIO", "SALMÃO", "SALTO", "SANGUE", "SAPATO", "SAPO", "SARDINHA",
        "SATÉLITE", "SAÚDE", "SECA", "SECRETO", "SÉCULO", "SEDA", "SEDE", "SEGREDO",
        "SEGUNDO", "SELO", "SELVAGEM", "SEMENTE", "SENHA", "SENHOR", "SEREIA", "SERINGA",
        "SERRA", "SERROTE", "SERVIÇO", "SINAL", "SINO", "SIRENE", "SISTEMA", "SOLDADO",
        "SOMBREIRO", "SOMBRA", "SONHO", "SONO", "SOPA", "SORRISO", "SUBMARINO", "SUEA",
        "SUL", "SUPER-HERÓI", "SUSPENSE", "TABELA", "TABLET", "TÁBUA", "TAÇA", "TALHER",
        "TAMBOR", "TANQUE", "TARDE", "TATU", "TATUAGEM", "TAXA", "TÁXI", "TEATRO",
        "TECLADO", "TEIA", "TELA", "TELEFONE", "TELESCOPIO", "TEMPESTADE", "TEMPLO", "TENTAÇÃO",
        "TENTÁCULO", "TERNO", "TERRA", "TERRAÇO", "TERREMOTO", "TESOURA", "TESOURO", "TESTA",
        "TETO", "TEXTO", "TIGELA", "TIJOLO", "TINTA", "TIO", "TIRO", "TÍTULO",
        "TOCHA", "TOMADA", "TOMATE", "TORNEIRA", "TORNOZELO", "TORRE", "TORTA", "TOSSE",
        "TOURO", "TRABALHO", "TRATOR", "TRAVESSEIRO", "TREVAS", "TRIGO", "TRILHA", "TRILHO",
        "TRONO", "TROVÃO", "TUBO", "TÚMULO", "TÚNEL", "TURISTA", "UNIVERSO", "URSO",
        "URUBÚ", "UVA", "VACA", "VACINA", "VAGA", "VAGÃO", "VALE", "VAMPIRO",
        "VARINHA", "VASO", "VASSOURA", "VEADO", "VELA", "VELHO", "VELOCIDADE", "VENENO",
        "VENTO", "VERÃO", "VERDADE", "VERME", "VESTIDO", "VETERINÁRIO", "VIAGEM", "VIDA",
        "VIDRO", "VILA", "VINHO", "VIOLÃO", "VÍRUS", "VISÃO", "VITÓRIA", "VITRINE",
        "VIZINHO", "VOCAÇÃO", "VULCÃO", "XADREZ", "XAMPU", "XAROPE", "XERIFE", "ZEBRA",
        "ZELADOR", "ZOOLÓGICO", "ZUMBI"
        ];

    async function ativarWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }
    ativarWakeLock();

    function inicializarServidor() {
        peer = new Peer();
        peer.on('open', (id) => {
            const url = window.location.href.split('?')[0] + '?sala=' + id;
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById("qrcode"), { text: url, width: 140, height: 140 });
            document.getElementById('qrcode-link').href = url;
            configurarNovaRodada();
        });

        peer.on('connection', (c) => {
            conn = c;
            conn.on('data', (data) => {
                if (data.type === 'REVELAR') animarERevelar(data.index);
                if (data.type === 'DESTACAR') destacarNaTV(data.index);
                if (data.type === 'CANCELAR_DESTAQUE') destacarNaTV(-1);
            });
            setTimeout(() => sincronizar(), 1000);
        });
    }

    function adicionarEquipe() {
        const coresExtras = ['#2ecc71', '#f1c40f', '#9b59b6', '#e67e22'];
        const novaCor = coresExtras[equipes.length % coresExtras.length];
        const id = 'extra_' + Date.now();
        equipes.push({ id: id, nome: 'NOVO TIME', vitorias: 0, cor: novaCor, progresso: 0, meta: 7 });
        atualizarInterfaceEquipes();
        gerarNovaRodada();
    }

    function removerEquipe(index) {
        if (equipes.length <= 2) return;
        if (confirm(`Remover equipe ${equipes[index].nome}?`)) {
            equipes.splice(index, 1);
            atualizarInterfaceEquipes();
            gerarNovaRodada();
        }
    }

    function atualizarInterfaceEquipes() {
        const configCont = document.getElementById('lista-equipes-config');
        const placarCont = document.getElementById('container-placares');
        configCont.innerHTML = ''; placarCont.innerHTML = '';

        equipes.forEach((eq, idx) => {
            const itemConfig = document.createElement('div');
            itemConfig.className = 'equipe-config';
            itemConfig.innerHTML = `
                <input type="text" class="edit-nome" value="${eq.nome}" oninput="equipes[${idx}].nome = this.value; atualizarNomesPlacar()">
                <input type="number" class="vit-num" value="${eq.vitorias}" onchange="equipes[${idx}].vitorias = parseInt(this.value); sincronizar()">
                ${equipes.length > 2 ? `<button class="btn-excluir" onclick="removerEquipe(${idx})">×</button>` : ''}
            `;
            configCont.appendChild(itemConfig);
            
            // Verifica se este time está no turno
            const ehTurno = (idx === dadosPartida.indexTurno);

            placarCont.innerHTML += `
                <div class="time-box ${ehTurno ? 'turno-ativo' : ''}" id="placar-${eq.id}" style="border-color: ${eq.cor}" onclick="mudarTurnoManualmente(${idx})">
                    <div class="nome-txt" style="color:${eq.cor}; font-size:0.8rem; font-weight:bold">${eq.nome}</div>
                    <span class="score-atual">${eq.progresso}/${eq.meta}</span>
                    <div class="indicador-vez">SUA VEZ</div>
                </div>`;
        });
    }

    // Permite clicar no placar para mudar o destaque do turno se necessário
    function mudarTurnoManualmente(index) {
        dadosPartida.indexTurno = index;
        atualizarInterfaceEquipes();
        sincronizar();
    }

    function atualizarNomesPlacar() {
        equipes.forEach(eq => {
            const el = document.querySelector(`#placar-${eq.id} .nome-txt`);
            if (el) el.innerText = eq.nome;
        });
        sincronizar();
    }

    function configurarNovaRodada() {
        dadosPartida.rodadaContador++;
        const quemComecaIdx = dadosPartida.rodadaContador % equipes.length;
        dadosPartida.indexTurno = quemComecaIdx; // O destaque começa no time que tem 9 cartas
        
        const embaralhado = [...palavrasBanco].sort(() => 0.5 - Math.random()).slice(0, 25);
        let cores = ['preto'];
        
        equipes.forEach((eq, i) => {
            eq.progresso = 0;
            eq.meta = (i === quemComecaIdx) ? 9 : 8;
            cores.push(...Array(eq.meta).fill(eq.id));
        });
        
        const neutrasQtd = 25 - cores.length;
        cores.push(...Array(neutrasQtd).fill('neutro'));
        cores.sort(() => 0.5 - Math.random());

        dadosPartida.palavras = embaralhado.map((p, i) => ({ texto: p, cor: cores[i], revelada: false }));
        
        document.getElementById('aviso-inicio').innerText = `O TIME ${equipes[quemComecaIdx].nome} COMEÇA!`;
        document.getElementById('overlay').style.display = 'none';
        
        renderizarTabuleiroTV();
        atualizarInterfaceEquipes();
        sincronizar();
    }

    function renderizarTabuleiroTV() {
        const container = document.getElementById('tabuleiro');
        container.innerHTML = '';
        dadosPartida.palavras.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `card ${p.revelada ? obterClasseCor(p.cor) : ''}`;
            if(p.revelada) div.style.backgroundColor = obterEstiloCor(p.cor);
            div.innerText = p.texto;
            div.onclick = () => { if(!p.revelada && confirm(`Revelar "${p.texto}"?`)) animarERevelar(i); };
            container.appendChild(div);
        });
    }

    function obterClasseCor(id) {
        if (id === 'neutro' || id === 'preto') return id;
        return (id === 'azul' || id === 'vinho') ? id : '';
    }

    function obterEstiloCor(id) {
        const eq = equipes.find(e => e.id === id);
        return eq ? eq.cor : '';
    }

    function animarERevelar(index) {
        const p = dadosPartida.palavras[index];
        if (p.revelada) return;
        
        p.revelada = true;
        const eqDonaDaCarta = equipes.find(e => e.id === p.cor);
        const timeNoTurno = equipes[dadosPartida.indexTurno];

        if (eqDonaDaCarta) eqDonaDaCarta.progresso++;

        // Lógica de troca de turno: se a carta revelada não for do time do turno, troca.
        if (p.cor !== timeNoTurno.id) {
            dadosPartida.indexTurno = (dadosPartida.indexTurno + 1) % equipes.length;
        }

        renderizarTabuleiroTV();
        atualizarInterfaceEquipes();
        sincronizar();
        checarFim(p.cor);
    }

    function checarFim(cor) {
        if (cor === 'preto') {
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('texto-vitoria').innerText = "O ASSASSINO FOI REVELADO!";
        } else {
            const vencedor = equipes.find(e => e.progresso >= e.meta);
            if (vencedor) {
                vencedor.vitorias++;
                document.getElementById('overlay').style.display = 'flex';
                document.getElementById('texto-vitoria').innerText = `VITÓRIA DO TIME ${vencedor.nome}!`;
                atualizarInterfaceEquipes();
            }
        }
    }

    function destacarNaTV(index) {
        const cards = document.querySelectorAll('#tabuleiro .card');
        cards.forEach((c, i) => i === index ? c.classList.add('foco-selecao') : c.classList.remove('foco-selecao'));
    }

    function sincronizar() {
        if (conn && conn.open) {
            conn.send({ type: 'DADOS', partida: dadosPartida, equipes: equipes });
        }
    }

    function gerarNovaRodada() {
        configurarNovaRodada();
    }

    function iniciarCapitao(salaId) {
        document.getElementById('tela-tv').classList.add('hidden');
        document.getElementById('campeonato').classList.add('hidden');
        document.getElementById('tela-capitao').classList.remove('hidden');
        
        peer = new Peer();
        peer.on('open', () => {
            const connCap = peer.connect(salaId);
            connCap.on('open', () => {
                connCap.on('data', (data) => {
                    if (data.type === 'DADOS') {
                        // Atualiza a interface do capitão baseada no turno também
                        dadosPartida.indexTurno = data.partida.indexTurno;
                        renderizarGabarito(data.partida, data.equipes, connCap);
                    }
                });
            });
        });
    }

    function renderizarGabarito(partida, listaEquipes, conexao) {
        const container = document.getElementById('tabuleiro-capitao');
        container.innerHTML = '';
        partida.palavras.forEach((p, i) => {
            const div = document.createElement('div');
            const eq = listaEquipes.find(e => e.id === p.cor);
            
            div.className = `card ${p.revelada ? 'revelada-cap' : ''}`;
            
            if (!p.revelada) {
                if (p.cor === 'preto') div.style.backgroundColor = '#000';
                else if (p.cor === 'neutro') div.style.backgroundColor = '#fbc531';
                else if (eq) div.style.backgroundColor = eq.cor;
                if (p.cor === 'preto' || eq) div.style.color = '#fff';
            }

            div.innerText = p.texto;
            div.onclick = () => {
                conexao.send({ type: 'DESTACAR', index: i });
                setTimeout(() => {
                    if (confirm(`Pedir para revelar "${p.texto}"?`)) {
                        conexao.send({ type: 'REVELAR', index: i });
                    }
                    conexao.send({ type: 'CANCELAR_DESTAQUE' });
                }, 200);
            };
            container.appendChild(div);
        });
    }

    const salaId = new URLSearchParams(window.location.search).get('sala');
    if (salaId) iniciarCapitao(salaId); else inicializarServidor();
</script>
</body>
</html>
